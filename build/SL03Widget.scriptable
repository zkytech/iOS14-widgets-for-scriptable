{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "blue",
    "glyph" : "car"
  },
  "name" : "SL03Widget",
  "script" : "\/**\n * iOS widget --- é•¿å®‰æ·±è“SL03æ¡Œé¢ç»„ä»¶ & é”å±ç»„ä»¶\n * é¡¹ç›®åœ°å€: https:\/\/github.com\/zkytech\/iOS14-widgets-for-scriptable\n * è”ç³»é‚®ç®±: zhangkunyuan@hotmail.com\n *\n *\n * å‚æ•°è·å–å’Œå¡«å†™æ–¹æ³•è§æ–‡æ¡£: https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable#4-%E6%B7%B1%E8%93%9Dsl03%E8%BD%A6%E8%BE%86%E7%8A%B6%E6%80%81\n * - ç»„ä»¶ä¾èµ–æ·±è“APPç™»å½•ä¿¡æ¯ï¼ˆrefresh_tokenï¼‰\n * - æœ¬ç»„ä»¶ä»…ç”¨äºå­¦ä¹ äº¤æµ\n * - æœ¬ç»„ä»¶ä¸ºå¼€æºè½¯ä»¶ï¼Œä¸ä¼šè¿›è¡Œæ”¶è´¹ï¼ï¼ï¼\n *\n *\n * - ä¸è¦åœ¨è„šæœ¬ä»£ç é‡Œä¿®æ”¹ä»»ä½•å‚æ•°ï¼Œæ‰€æœ‰å‚æ•°å¿…é¡»é€šè¿‡ç»„ä»¶è®¾ç½®ç•Œé¢å¡«å†™\n *\/\ntry {\n  \/\/ å¼€å‘ç¯å¢ƒåˆ‡æ¢åˆ°devåˆ†æ”¯ï¼Œç”Ÿäº§ç¯å¢ƒç”¨masteråˆ†æ”¯\n  const branch = \"master\";\n  const project_name = \"æ·±è“å°ç»„ä»¶_by_zkytech\";\n  \/\/ const force_download = branch != \"master\";\n  const force_download = true;\n  const url_scheme = \"qiyuancar:\/\/\";\n\n\n  class WidgetTheme {\n    constructor(\n      name,\n      backgroundGradient,\n      primaryTextColor,\n      secondaryTextColor\n    ) {\n      this.name = name;\n      this.backgroundGradient = backgroundGradient;\n      this.primaryTextColor = primaryTextColor;\n      this.secondaryTextColor = secondaryTextColor;\n    }\n  }\n\n  function getGradient(colors, locations) {\n    const gradient = new LinearGradient();\n    gradient.colors = colors;\n    gradient.locations = locations;\n    return gradient;\n  }\n\n  const themes = [\n    new WidgetTheme(\n      \"è·Ÿéšç³»ç»Ÿ\",\n      getGradient([Color.dynamic(Color.white(), Color.black())], [1]),\n      Color.dynamic(Color.black(), Color.white()),\n      Color.dynamic(new Color(\"#4b4b4b\"), new Color(\"#bfbfbf\"))\n    ),\n    new WidgetTheme(\n      \"ç™½è‰²ä¸»é¢˜\",\n      getGradient([Color.white()], [1]),\n      Color.black(),\n      new Color(\"#4b4b4b\")\n    ),\n    new WidgetTheme(\n      \"é»‘è‰²ä¸»é¢˜\",\n      getGradient([Color.black()], [1]),\n      Color.white(),\n      new Color(\"#bfbfbf\")\n    ),\n    new WidgetTheme(\n      \"è·Ÿéšç³»ç»Ÿ(æ¸å˜)\",\n      getGradient(\n        [\n          Color.dynamic(Color.white(), Color.black()),\n          Color.dynamic(new Color(\"#ced6e0\"), new Color(\"#2f3542\")),\n        ],\n        [0, 1]\n      ),\n      Color.dynamic(Color.black(), Color.white()),\n      Color.dynamic(new Color(\"#4b4b4b\"), new Color(\"#bfbfbf\"))\n    ),\n    new WidgetTheme(\n      \"ç™½è‰²ä¸»é¢˜(æ¸å˜)\",\n      getGradient([Color.white(), new Color(\"#ced6e0\")], [0, 1]),\n      Color.black(),\n      new Color(\"#4b4b4b\")\n    ),\n    new WidgetTheme(\n      \"é»‘è‰²ä¸»é¢˜(æ¸å˜)\",\n      getGradient([Color.black(), new Color(\"#2f3542\")], [0, 1]),\n      Color.white(),\n      new Color(\"#bfbfbf\")\n    ),\n    new WidgetTheme(\n      \"EVAåˆå·æœºä¸»é¢˜\",\n      getGradient([new Color(\"#6c5ce7\")], [1]),\n      new Color(\"#00b894\"),\n      new Color(\"#00b894\")\n    ),\n  ];\n\n  const {\n    getCarId,\n    getToken,\n    refreshCarData,\n    getBalanceInfo,\n    getCarStatus,\n    getCarInfo,\n    getCarLocation,\n    getChargeStatus,\n  } = await getService(\n    \"SL03Api\",\n    `https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable\/lib\/service\/SL03Api.js`,\n    force_download\n  );\n  const { update } = await getService(\n    \"UpdateScript\",\n    `https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable\/lib\/service\/UpdateScript.js`,\n    force_download\n  );\n  let { getDataFromSettings, saveDataToSettings } = await getService(\n    \"Settings\",\n    `https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable\/lib\/service\/Settings.js`,\n    force_download\n  );\n  function getSetting(key) {\n    return getDataFromSettings(project_name, key);\n  }\n  function saveSetting(key, value) {\n    return saveDataToSettings(project_name, key, value);\n  }\n\n  if (branch == \"master\") {\n    \/\/ æ›´æ–°ç»„ä»¶ä»£ç \n    await update(\n      `https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable\/SL03Widget.js`\n    );\n  }\n\n  if (config.runsInWidget) {\n    try {\n      switch (config.widgetFamily) {\n        case \"medium\":\n          await renderMediumWidget();\n          break;\n        case \"accessoryCircular\":\n          await renderAccessoryCircularWidget();\n          break;\n        default:\n          await renderWrongSizeAlert();\n          break;\n      }\n    } catch (e) {\n      console.log(e);\n    }\n  } else {\n    \/\/ åœ¨Scriptableä¸­è¿è¡Œï¼Œå¼¹å‡ºè®¾ç½®çª—å£\n    await askSettings();\n  }\n\n  \/**\n   * å°å·é”å±ç»„ä»¶\n   * æ¥å—å‚æ•° - æ˜¾ç¤ºæ¨¡å¼ï¼Œæ²¹\/ç”µ\n   *\/\n  async function renderAccessoryCircularWidget() {\n    const { drawArc } = await getService(\n      \"DrawShape\",\n      `https:\/\/public.zkytech.top\/iOS14-widgets-for-scriptable\/lib\/service\/DrawShape.js`,\n      force_download\n    );\n    const params = args.widgetParameter\n      ? args.widgetParameter.split(\",\")\n      : [\"\"];\n    let mode = \"ç”µ\";\n    if (params.length >= 1) mode = params[0].trim() == \"æ²¹\" ? \"æ²¹\" : \"ç”µ\";\n    const LW = new ListWidget(); \/\/ widgetå¯¹è±¡\n    LW.url = url_scheme;\n    let token;\n    let refresh_token = getRefreshToken();\n    const token_result = await getToken(refresh_token);\n    if (token_result == null) {\n      token = null;\n    } else {\n      refresh_token = token_result.refresh_token;\n      token = token_result.access_token;\n      if (\n        refresh_token != \"\" &&\n        refresh_token != undefined &&\n        refresh_token != null\n      ) {\n        console.log(\"ä¿å­˜æ–°çš„refresh_token\");\n        saveSetting(\"refresh_token\", refresh_token);\n      }\n    }\n\n    const car_id = await getCarId(token);\n    const car_status = await getCarStatus(token, car_id);\n    const charge_status = await getChargeStatus(token, car_id);\n    \/\/ å¯ä»¥ç¡®å®š çŠ¶æ€ç 3 = â€œæœªå……ç”µâ€\n    \/\/ çŠ¶æ€ç 1 = â€œå……ç”µä¸­â€\n    \/\/ çŠ¶æ€ç 2 ç›®å‰æœªçŸ¥\n    const is_charging = charge_status.chrgStatus == \"1\";\n    if (car_status && car_id) {\n      \/\/ å‰©ä½™ç”µé‡\n      let remain_power =\n        car_status.remainPower == undefined || car_status.remainPower < 0\n          ? 0\n          : car_status.remainPower;\n      let remained_oil_mile = car_status.RemainedOilMile;\n      \/\/ å¢ç¨‹è½¦å‹å­˜åœ¨APIæ•°æ®é”™ä¹±çš„é—®é¢˜ï¼Œä¸ºäº†é¿å…å—åˆ°APIé”™è¯¯æ•°æ®çš„å½±å“è‡ªåŠ¨å–ä¸Šä¸€æ¬¡è·å–åˆ°çš„åˆç†æ•°æ®\n      if (remain_power && remain_power > 0) {\n        saveSetting(\"remain_power\", remain_power);\n      } else {\n        remain_power = getSetting(\"remain_power\");\n        remain_power = remain_power ? remain_power : 0;\n      }\n      if (remained_oil_mile && remained_oil_mile > 0) {\n        saveSetting(\"remained_oil_mile\", remained_oil_mile);\n      } else {\n        remained_oil_mile = getSetting(\"remained_oil_mile\");\n        remained_oil_mile = remained_oil_mile ? remained_oil_mile : 0;\n      }\n\n      const remain_oil = (remained_oil_mile \/ 846) * 100;\n      const circle = await drawArc(\n        LW,\n        mode == \"ç”µ\" ? remain_power : remain_oil\n      );\n\n      const car_symbol_name =\n        mode == \"ç”µ\"\n          ? is_charging\n            ? \"bolt.car.fill\"\n            : \"car.rear.fill\"\n          : \"fuelpump.fill\";\n      \/\/ const sf_car = circle.addImage(SFSymbol.named(car_symbol_name).image);\n      const sf_car = circle.addImage(await loadImage(\"é”å±è½¦\"));\n\n      sf_car.imageSize = new Size(29, 29);\n      sf_car.tintColor = Color.white();\n    }\n\n    if (token == \"\" || token == null || token == undefined) {\n      console.error(\"è¯·å…ˆé…ç½®refresh_token\");\n      LW.addText(\"è¯·å…ˆé…ç½®refresh_token\");\n    }\n\n    LW.presentAccessoryCircular();\n\n    Script.setWidget(LW);\n    Script.complete();\n  }\n\n  \/**\n   * ä¸­ç­‰æ¡Œé¢ç»„ä»¶\n   * æ¥å—å‚æ•° - refresh_token\n   *\/\n  async function renderMediumWidget() {\n    const params = args.widgetParameter\n      ? args.widgetParameter.split(\",\")\n      : [\"\"];\n    const theme = getTheme();\n    param_refresh_token = params.length > 0 ? params[0].trim() : \"\";\n    if (param_refresh_token && !getRefreshToken()) {\n      saveSetting(\"refresh_token\", param_refresh_token);\n    }\n    const LW = new ListWidget(); \/\/ widgetå¯¹è±¡\n    LW.url = url_scheme;\n    LW.backgroundGradient = theme.backgroundGradient;\n    let token;\n    let refresh_token = getRefreshToken();\n    const token_result = await getToken(refresh_token);\n    if (token_result == null) {\n      token = null;\n    } else {\n      refresh_token = token_result.refresh_token;\n      token = token_result.access_token;\n      if (\n        refresh_token != \"\" &&\n        refresh_token != undefined &&\n        refresh_token != null\n      ) {\n        console.log(\"ä¿å­˜æ–°çš„refresh_token\");\n        saveSetting(\"refresh_token\", refresh_token);\n      }\n    }\n    const car_id = await getCarId(token);\n    \/\/ await refreshCarData()\n    const car_status = await getCarStatus(token, car_id);\n    const car_info = await getCarInfo(token, car_id);\n    const car_location = await getCarLocation(token, car_id);\n    const charge_status = await getChargeStatus(token, car_id);\n    const balance_info = await getBalanceInfo(token, car_id);\n    if (car_status != null && car_info != null && car_location != null) {\n      \/\/ æ•°æ®æ›´æ–°æ—¶é—´\n      const update_time = car_status.terminalTime;\n      \/\/ æ€»é‡Œç¨‹\n      const total_odometer = Math.round(car_status.totalOdometer);\n      \/\/ è½¦å†…æ¸©åº¦\n      const vehicle_temperature = Math.round(car_status.vehicleTemperature);\n      \/\/ å‰©ä½™é‡Œç¨‹\n      let remained_power_mile = Math.round(car_status.remainedPowerMile);\n      \/\/ å‰©ä½™ç”µé‡\n      let remain_power = Math.round(car_status.remainPower);\n      \/\/ è½¦è¾†åç§°\n      const car_name = car_info.carName;\n      \/\/ è½¦è¾†é…ç½®åç§°ï¼Œæ¯”å¦‚ï¼š515km\n      const conf_name = car_info.confName\n        ? car_info.confName.split(\"ï¼Œ\")[2]\n        : \"\";\n      \/\/ è½¦ç‰Œå·\n      const plate_number = car_info.plateNumber;\n      \/\/ å‹å·\n      const series_name = car_info.seriesName;\n      \/\/ è½¦è¾†ä½ç½®\n      const location_str = car_location.addrDesc;\n      \/\/ è½¦é—¨çŠ¶æ€\n      const lock_status =\n        car_status.driverDoorLock == 0 && car_status.passengerDoorLock == 0;\n      \/\/ æ˜¯å¦ä¸ºå¢ç¨‹è½¦å‹\n      const is_mix = car_status.remainedOilMile != undefined;\n      \/\/ æ˜¯å¦åœ¨å……ç”µ\n      const is_charging = charge_status.chrgStatus != \"3\";\n      \/\/ ç»åº¦\n      const lng = car_location.lng;\n      \/\/ çº¬åº¦\n      const lat = car_location.lat;\n      \/\/ å¢ç¨‹æ²¹ç®±ç»­èˆªé‡Œç¨‹\n      let remained_oil_mile = is_mix\n        ? Math.round(car_status.remainedOilMile)\n        : 0;\n      \/\/ å¢ç¨‹è½¦å‹å­˜åœ¨APIæ•°æ®é”™ä¹±çš„é—®é¢˜ï¼Œè¿™é‡Œä¸ºäº†å—åˆ°APIé”™è¯¯æ•°æ®çš„å½±å“è‡ªåŠ¨å–ä¸Šä¸€æ¬¡è·å–åˆ°çš„åˆç†æ•°æ®\n      if (remain_power && remain_power > 0) {\n        saveSetting(\"remain_power\", remain_power);\n      } else {\n        remain_power = getSetting(\"remain_power\");\n        remain_power = remain_power ? remain_power : 0;\n      }\n      if (remained_power_mile && remained_power_mile > 0) {\n        saveSetting(\"remained_power_mile\", remained_power_mile);\n      } else {\n        remained_power_mile = getSetting(\"remained_power_mile\");\n        remained_power_mile = remained_power_mile ? remained_power_mile : 0;\n      }\n      if (remained_oil_mile && remained_oil_mile > 0) {\n        saveSetting(\"remained_oil_mile\", remained_oil_mile);\n      } else {\n        remained_oil_mile = getSetting(\"remained_oil_mile\");\n        remained_oil_mile = remained_oil_mile ? remained_oil_mile : 0;\n      }\n      \/\/ å‰©ä½™æ²¹é‡\n      const remain_oil = (remained_oil_mile \/ 846) * 100;\n      \/\/ ç»¼åˆç»­èˆª(å¢ç¨‹)\n      const total_mixed_mile = remained_power_mile + remained_oil_mile;\n      \/\/ å‰©ä½™æµé‡\n      const remained_packet_size = Math.round(balance_info[0].left);\n      \/\/ å‰©ä½™æµé‡å•ä½\n      const remained_packet_size_unit = balance_info[0].totalUnit;\n\n      const widget_data_map = {\n        ç”µæ± ç»­èˆª: {\n          value: remained_power_mile,\n          unit: \"km\",\n        },\n        æ²¹ç®±ç»­èˆª: {\n          value: remained_oil_mile,\n          unit: \"km\",\n        },\n        å‰©ä½™ç”µé‡: {\n          value: remain_power,\n          unit: \"%\"\n        },\n        å‰©ä½™æ²¹é‡: {\n          value: remain_oil,\n          unit: \"%\"\n        },\n        æ€»é‡Œç¨‹: {\n          value: total_odometer,\n          unit: \"km\",\n        },\n        ç»¼åˆç»­èˆª: {\n          value: total_mixed_mile,\n          unit: \"km\",\n        },\n        æ¸©åº¦: {\n          value: vehicle_temperature,\n          unit: \"Â°C\",\n        },\n        ä½ç½®: {\n          value: location_str,\n          unit: \"\",\n          url: `iosamap:\/\/path?sourceApplication=SL03Widget&dlat=${lat}&dlon=${lng}`,\n        },\n        å‰©ä½™æµé‡: {\n          value: remained_packet_size,\n          unit: remained_packet_size_unit,\n        },\n      };\n\n      \/\/const power_img = LW.addImage(drawPowerImage(remain_power,remained_power_mile))\n      \/\/power_img.cornerRadius=5\n      \/\/power_img.imageSize=new Size(300,18)\n      \/**\n        |    col0 |   col1_0|   col1_1 |\n        |---------|---------|----------|\n        |         | æ€»é‡Œç¨‹   | ç»­èˆªé‡Œç¨‹  |\n        | è½¦è¾†å›¾ç‰‡ |  xxxkm |   xxkm   |\n        |         | t_space0| t_space1  |\n        | ------- |----------|---------|\n        | è½¦è¾†åç§° |  æ¸©åº¦     | ä½ç½®     |\n        | ------- | xxæ‘„æ°åº¦. | xxxçœxxxå¸‚ |\n        |         | t_space2 | t_space3  |\n        | è½¦ç‰Œå·   |---------------------ï½œ\n        |        | æ•°æ®æ›´æ–°æ—¶é—´          |\n        | col0   |        col1           |\n    *\/\n      const container = LW.addStack();\n      container.layoutHorizontally();\n      container.spacing = 15;\n      \/\/ ç¬¬1åˆ—\n      const col0 = container.addStack();\n      col0.layoutVertically();\n      col0.spacing = 6;\n      col0.size = new Size(110, 0);\n      \/\/ è½¦è¾†å›¾ç‰‡\n      const car_img = await loadImage(\"è½¦\");\n      const car_stack = col0.addStack();\n\n      const img_container = car_stack.addImage(car_img);\n\n      img_container.imageSize = new Size(100, 50);\n      \/\/ è½¦è¾†åç§°ã€å‹å·\n      const car_name_container = col0.addStack();\n\n      car_name_container.layoutHorizontally();\n      car_name_container.spacing = 3;\n      car_name_container.bottomAlignContent();\n\n      \/\/ è½¦è¾†åç§°\n      const car_name_text = car_name_container.addText(car_name);\n      car_name_text.font = Font.boldSystemFont(15);\n      car_name_text.textColor = theme.primaryTextColor;\n      car_name_text.shadowColor = theme.secondaryTextColor;\n      car_name_text.shadowRadius = 1;\n      car_name_text.shadowOffset = new Point(1, 1);\n\n      \/\/car_name_text.minimumScaleFactor = 1\n      const lock_icon = car_name_container.addImage(\n        lock_status\n          ? SFSymbol.named(\"lock.fill\").image\n          : SFSymbol.named(\"lock.open.fill\").image\n      );\n      const charge_icon = car_name_container.addImage(\n        SFSymbol.named(\"bolt.fill\").image\n      );\n      \/\/ = SFSymbol.named(\"lock.open.fill\")\n      lock_icon.tintColor = lock_status\n        ? new Color(\"#27ae60\")\n        : new Color(\"#c0392b\");\n      charge_icon.tintColor = is_charging ? new Color(\"#27ae60\") : Color.gray();\n      lock_icon.imageSize = new Size(15, 15);\n      charge_icon.imageSize = new Size(15, 15);\n      const car_seires_container = col0.addStack();\n      \/\/ è½¦è¾†logo\n      const logo = car_seires_container.addImage(await loadImage(\"LOGO\"));\n      logo.imageSize = new Size(12, 12);\n      \/\/ è½¦è¾†å‹å·\n      const user_defined_series_name = getSetting(\"car_series_name\");\n      const car_series_text = car_seires_container.addText(\n        user_defined_series_name\n          ? user_defined_series_name\n          : series_name + \" \" + conf_name\n      );\n      car_series_text.font = Font.mediumSystemFont(11);\n      car_series_text.textColor = theme.secondaryTextColor;\n      \/\/car_series_text.minimumScaleFactor = 0.5\n\n      \/\/ è½¦ç‰Œå·\n      const plate_number_text = col0.addText(plate_number);\n      plate_number_text.font = Font.thinMonospacedSystemFont(10);\n      plate_number_text.textColor = theme.secondaryTextColor;\n      \/\/car_series_text.minimumScaleFactor = 0.5\n\n      \/\/ ç¬¬2åˆ—\n      const col1 = container.addStack();\n\n      col1.layoutVertically();\n      col1.spacing = 8;\n      const col1_row0 = col1.addStack();\n      const col1_row1 = col1.addStack();\n      col1_row1.layoutHorizontally();\n      col1_row1.spacing = 5;\n\n      const refresh_icon = col1_row1.addImage(\n        SFSymbol.named(\"arrow.clockwise\").image\n      );\n      refresh_icon.tintColor = theme.secondaryTextColor;\n      refresh_icon.imageSize = new Size(13, 13);\n      const refresh_time_text = col1_row1.addText(update_time);\n      refresh_time_text.textColor = theme.secondaryTextColor;\n      refresh_time_text.font = Font.thinMonospacedSystemFont(13);\n\n      col1_row0.layoutHorizontally();\n      col1_row0.spacing = 15;\n      const col1_row0_row0 = col1_row0.addStack();\n      const col1_row0_row1 = col1_row0.addStack();\n      col1_row0_row0.layoutVertically();\n      col1_row0_row1.layoutVertically();\n      col1_row0_row0.spacing = 8;\n      col1_row0_row1.spacing = 8;\n      const t_space0 = col1_row0_row0.addStack();\n      const t_space2 = col1_row0_row0.addStack();\n      const t_space1 = col1_row0_row1.addStack();\n      const t_space3 = col1_row0_row1.addStack();\n      const space_list = [t_space0, t_space1, t_space2, t_space3];\n      space_list.map((space, i) => {\n        space.layoutVertically();\n        const data_key = getWiegetDataSpaceName(i, is_mix);\n\n        \/\/ æ ‡é¢˜\n        const header_stack = space.addText(data_key);\n        \/\/ æ•°æ®å®¹å™¨\n        const content_container = space.addStack();\n        content_container.spacing = 5;\n        content_container.bottomAlignContent();\n        \/\/ æ•°æ®-å€¼\n        const content_stack = content_container.addText(\n          widget_data_map[data_key].value + \"\"\n        );\n        \/\/ æ•°æ®-å•ä½\n        const unit_stack = content_container.addText(\n          widget_data_map[data_key].unit + \"\"\n        );\n        \/\/ è·³è½¬åœ°å€\n        if (widget_data_map[data_key].url) {\n          space.url = widget_data_map[data_key].url;\n        }\n        header_stack.font = Font.thinMonospacedSystemFont(12);\n        header_stack.textColor = theme.secondaryTextColor;\n        content_stack.font = Font.boldSystemFont(18);\n        content_stack.textColor = theme.primaryTextColor;\n        content_stack.minimumScaleFactor = 0.3;\n        unit_stack.font = Font.mediumMonospacedSystemFont(14);\n        unit_stack.textColor = theme.secondaryTextColor;\n      });\n\n      const background_image = await loadImage(\"èƒŒæ™¯å›¾\");\n      background_image ? (LW.backgroundImage = background_image) : null;\n    }\n    if (token == \"\" || token == null || token == undefined) {\n      console.error(\"è¯·å…ˆé…ç½®refresh_token\");\n      const t = LW.addText(\n        \"è¯·å…ˆåœ¨scriptable appä¸­ç›´æ¥è¿è¡Œæ­¤è„šæœ¬å¹¶é…ç½®refresh_token\"\n      );\n      t.font = Font.boldSystemFont(18);\n      t.textColor = Color.red();\n    }\n    console.log(\"æ¸²æŸ“ç»“æŸ\");\n    await LW.presentMedium();\n    Script.setWidget(LW);\n    Script.complete();\n  }\n  function getFileManager() {\n    let fm;\n    try {\n      fm = FileManager.iCloud();\n      fm.documentsDirectory();\n    } catch {\n      fm = FileManager.local();\n    }\n    return fm;\n  }\n\n  async function renderWrongSizeAlert() {\n    const LW = new ListWidget();\n    const alert_text = LW.addText(\n      \"æœ¬ç»„ä»¶åªæ”¯æŒä¸­ç­‰å¤§å°ï¼Œè¯·é‡æ–°æ·»åŠ ä¸­ç­‰å¤§å°æ¡Œé¢ç»„ä»¶\"\n    );\n    alert_text.textColor = Color.red();\n    LW.present();\n    Script.setWidget(LW);\n    Script.complete();\n  }\n\n  function getImageDir() {\n    const fm = getFileManager();\n    const script_dir = fm.documentsDirectory();\n    let img_dir = fm.joinPath(script_dir, \"imgs\");\n    if (!fm.fileExists(img_dir)) {\n      fm.createDirectory(img_dir, true);\n    }\n    return img_dir;\n  }\n\n  \/\/ åŠ è½½å›¾ç‰‡\n  async function loadImage(name) {\n    const img_map = {\n      è½¦: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PMpHE.png\",\n      LOGO: \"https:\/\/deepal.com.cn\/202303112321\/share_logo.png\",\n      é”å±è½¦: \"https:\/\/i.328888.xyz\/2023\/03\/27\/inBH5a.png\"\n    };\n    const user_defined_settings_name_map = {\n      è½¦: \"car_img_path\",\n      LOGO: \"logo_img_path\",\n      èƒŒæ™¯å›¾: \"widget_background_path\",\n    };\n    const fm = getFileManager();\n    let user_defined_img_path = getSetting(\n      user_defined_settings_name_map[name]\n    );\n    \/\/ ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å›¾ç‰‡\n    console.log(\"åŠ è½½å›¾ç‰‡:\" + name + \" \" + user_defined_img_path);\n    if (user_defined_img_path && fm.fileExists(user_defined_img_path)) {\n      try {\n        fm.downloadFileFromiCloud(user_defined_img_path);\n      } catch (e) {}\n      return fm.readImage(user_defined_img_path);\n    }\n    if (user_defined_img_path && !fm.fileExists(user_defined_img_path)) {\n      console.log(`ç”¨æˆ·è‡ªå®šä¹‰å›¾ç‰‡ä¸å­˜åœ¨:${name}`);\n      saveSetting(user_defined_settings_name_map[name], \"\");\n      user_defined_img_path = null;\n    }\n    if (!img_map[name] && !user_defined_img_path) {\n      return null;\n    }\n    const img_url = img_map[name];\n    const file_name = img_url.split(\"\/\")[img_url.split(\"\/\").length - 1];\n\n    let img_dir = getImageDir();\n\n    if (!fm.fileExists(img_dir)) {\n      fm.createDirectory(img_dir, true);\n    }\n    let img_file = fm.joinPath(img_dir, file_name + \".png\");\n\n    if (fm.fileExists(img_file)) {\n      console.log(`ä»æœ¬åœ°ç¼“å­˜ä¸­åŠ è½½å›¾ç‰‡:${name}`);\n      try {\n        fm.downloadFileFromiCloud(img_file);\n      } catch (e) {}\n    } else {\n      \/\/ download once\n      console.log(`å¼€å§‹ä¸‹è½½å›¾ç‰‡:${name}`);\n      const req = new Request(img_url);\n      const img = await req.loadImage();\n      fm.writeImage(img_file, img);\n    }\n    \/\/ const user_defined_settings_key = user_defined_settings_name_map[name];\n    \/\/ const user_defined_img_path = getSetting(user_defined_settings_key);\n    \/\/ if (user_defined_img_path && fm.fileExists(user_defined_img_path)) {\n    \/\/   return fm.readImage(user_defined_img_path);\n    \/\/ } else {\n    return fm.readImage(img_file);\n    \/\/ }\n  }\n\n  function getRefreshToken() {\n    const fm = getFileManager();\n    const script_dir = fm.documentsDirectory();\n    const old_refresh_token_path = fm.joinPath(script_dir, \"refresh_token\");\n    \/\/ å¤„ç†å†å²é—ç•™é—®é¢˜ï¼Œå°†è€ç‰ˆæœ¬çš„refresh_tokenæ–‡ä»¶ç»Ÿä¸€ç”¨æ–°çš„settings.jsonæ›¿ä»£\n    if (fm.fileExists(old_refresh_token_path)) {\n      const old_refresh_token = fm.readString(old_refresh_token_path);\n      saveSetting(\"refresh_token\", old_refresh_token);\n      fm.remove(old_refresh_token_path);\n    }\n    let refresh_token = getSetting(\"refresh_token\");\n    return refresh_token;\n  }\n\n  async function getService(name, url, force_download) {\n    const fm = getFileManager();\n    const script_dir = fm.documentsDirectory();\n    let service_dir = fm.joinPath(script_dir, \"lib\/service\/\" + name);\n\n    if (!fm.fileExists(service_dir)) {\n      fm.createDirectory(service_dir, true);\n    }\n\n    let lib_file = fm.joinPath(script_dir, \"lib\/service\/\" + name + \"\/index.js\");\n\n    if (fm.fileExists(lib_file) && !force_download) {\n      try {\n        fm.downloadFileFromiCloud(lib_file);\n      } catch (e) {}\n    } else {\n      \/\/ download once\n      const req = new Request(url);\n      let indexjs = await req.load();\n      fm.write(lib_file, indexjs);\n    }\n\n    let service = importModule(\"lib\/service\/\" + name);\n\n    return service;\n  }\n\n  async function selectCarColor() {\n    const colors = [\n      {\n        name: \"æ˜Ÿäº‘é’\",\n        img_url: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PM3NF.png\",\n      },\n      {\n        name: \"æœˆå²©ç°\",\n        img_url: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PMrAZ.png\",\n      },\n      {\n        name: \"å¤©æ²³è“\",\n        img_url: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PMRhH.png\",\n      },\n      {\n        name: \"æ˜ŸçŸ¿é»‘\",\n        img_url: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PMcuQ.png\",\n      },\n      {\n        name: \"å½—æ˜Ÿç™½\",\n        img_url: \"https:\/\/i.328888.xyz\/2023\/03\/20\/PMpHE.png\",\n      },\n    ];\n    const alert = new Alert();\n    alert.title = \"è¯·é€‰æ‹©è½¦è¾†é¢œè‰²\";\n    colors.map((color) => {\n      alert.addAction(color.name);\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    const action_index = await alert.presentAlert();\n    if (action_index >= 0) {\n      const req = new Request(colors[action_index].img_url);\n      const image = await req.loadImage();\n      if (!image) {\n        console.error(\"å›¾ç‰‡ç´ æåŠ è½½å¤±è´¥\");\n        return;\n      }\n      const fm = getFileManager();\n      const img_dir = getImageDir();\n      const img_file_path = fm.joinPath(img_dir, \"car_img.jpg\");\n      fm.writeImage(img_file_path, image);\n      saveSetting(\"car_img_path\", img_file_path);\n    }\n  }\n\n  async function previewWidget() {\n    const alert = new Alert();\n    alert.title = \"è¯·é€‰æ‹©é¢„è§ˆå†…å®¹\";\n    const preview_actions = [\n      {\n        title: \"ğŸŒ¤ï¸é”å±ç»„ä»¶\",\n        action: async () => await renderAccessoryCircularWidget(),\n      },\n      {\n        title: \"ğŸ“±æ¡Œé¢ç»„ä»¶\",\n        action: async () => await renderMediumWidget(),\n      },\n    ];\n    preview_actions.map((action) => {\n      alert.addAction(action.title);\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    await alert.presentAlert().then((action_index) => {\n      if (action_index >= 0) {\n        return preview_actions[action_index].action();\n      }\n    });\n  }\n\n  async function selectTheme() {\n    const alert = new Alert();\n    alert.title = \"è¯·é€‰æ‹©ä¸»é¢˜\";\n    let curr_theme = getSetting(\"theme_name\");\n    curr_theme = curr_theme ? curr_theme : \"è·Ÿéšç³»ç»Ÿ\";\n    themes.map((theme) => {\n      alert.addAction(\n        theme.name == curr_theme ? theme.name + \"(å½“å‰)\" : theme.name\n      );\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    const selection = await alert.presentAlert();\n    if (selection >= 0) {\n      saveSetting(\"theme_name\", themes[selection].name);\n    }\n    return selection;\n  }\n\n  function getTheme() {\n    let theme_name = getSetting(\"theme_name\");\n    if (!theme_name) theme_name = \"è·Ÿéšç³»ç»Ÿ(æ¸å˜)\";\n    return themes.find((theme) => theme.name == theme_name);\n  }\n\n  \/\/ è·å–ç¬¬iä¸ªç»„ä»¶æ•°æ®å—çš„åç§°\n  function getWiegetDataSpaceName(i, is_mix) {\n    const key = \"widget_data_block_info\";\n    if (getSetting(key) && getSetting(key)[i]) {\n      return getSetting(key)[i];\n    } else {\n      \/\/ ä¸ºä¸åŒè½¦å‹åˆ›å»ºä¸åŒçš„é»˜è®¤è®¾ç½®ï¼šå¢ç¨‹\/çº¯ç”µ\n      let default_datas = [];\n      if (is_mix) {\n        default_datas = [\"ç”µæ± ç»­èˆª\", \"æ²¹ç®±ç»­èˆª\", \"æ€»é‡Œç¨‹\", \"ä½ç½®\"];\n      } else {\n        default_datas = [\"æ€»é‡Œç¨‹\", \"ç”µæ± ç»­èˆª\", \"æ¸©åº¦\", \"ä½ç½®\"];\n      }\n      saveSetting(key, default_datas);\n      return default_datas[i];\n    }\n  }\n\n  function setWidgetDataSpaceName(i, value) {\n    const key = \"widget_data_block_info\";\n    if (getSetting(key) && getSetting(key)[i]) {\n      const tmp = getSetting(key);\n      tmp[i] = value;\n      saveSetting(key, tmp);\n    }\n  }\n\n  async function selectDataForBlock(i) {\n    const data_name_list = [\n      \"ç”µæ± ç»­èˆª\",\n      \"æ²¹ç®±ç»­èˆª\",\n      \"å‰©ä½™ç”µé‡\",\n      \"å‰©ä½™æ²¹é‡\",\n      \"æ€»é‡Œç¨‹\",\n      \"ç»¼åˆç»­èˆª\",\n      \"æ¸©åº¦\",\n      \"ä½ç½®\",\n      \"å‰©ä½™æµé‡\",\n    ];\n    const curr_selection = getWiegetDataSpaceName(i);\n    const alert = new Alert();\n    alert.title = \"è¯·é€‰æ‹©ç¬¬\" + (i + 1) + \"ä¸ªæ•°æ®å—çš„æ•°æ®\";\n    data_name_list.map((data_name) => {\n      alert.addAction(data_name == curr_selection ? data_name + \"(å½“å‰)\" : data_name);\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    const selection = await alert.presentAlert();\n    if (selection >= 0) {\n      await setWidgetDataSpaceName(i, data_name_list[selection]);\n    }\n  }\n\n  async function listDataBlocks() {\n    const alert = new Alert();\n    alert.title = \"è¯·é€‰æ‹©æ•°æ®å—\";\n    alert.message = \"åˆ†åˆ«ä»£è¡¨å°ç»„ä»¶å³ä¾§çš„å››ä¸ªæ•°æ®å—\"\n    const data_block_list = [1, 2, 3, 4];\n    data_block_list.map((data_block) => {\n      alert.addAction(\"ç¬¬\" + data_block + \"ä¸ªæ•°æ®å—\");\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    const selection = await alert.presentAlert();\n    if (selection >= 0) {\n      if (\n        getSetting(\"widget_data_block_info\") &&\n        getSetting(\"widget_data_block_info\")[1]\n      ) {\n        await selectDataForBlock(selection);\n      } else {\n        const err_alert = new Alert();\n        err_alert.title = \"è¯·å…ˆæ‰§è¡Œä¸€éé¢„è§ˆç¨‹åº\";\n        err_alert.message = \"è¯·å…ˆæ‰§è¡Œä¸€éé¢„è§ˆç¨‹åºï¼Œç„¶åå†ä¿®æ”¹æ•°æ®å—è®¾ç½®\";\n      }\n    }\n  }\n\n  \/\/ å¼¹å‡ºæ“ä½œé€‰å•ï¼Œè¿›è¡Œè‡ªå®šä¹‰è®¾ç½®\n  async function askSettings() {\n    const alert = new Alert();\n    alert.title = \"æ·±è“å°ç»„ä»¶è®¾ç½®\";\n    alert.message = \"created by @zkytech\";\n    const setting_actions = [\n      {\n        title: \"ğŸ“–æŸ¥çœ‹è¯´æ˜æ–‡æ¡£\",\n        action: async () => {\n          await Safari.open(\n            \"https:\/\/gitee.com\/zkytech\/iOS14-widgets-for-scriptable\"\n          );\n        },\n      },\n      {\n        title: \"ğŸ› ï¸è®¾ç½®refresh_token\",\n        action: async () => {\n          let my_alert = new Alert();\n          let refresh_token = getSetting(\"refresh_token\");\n          my_alert.title = \"è¯·è¾“å…¥refresh_token\";\n          my_alert.addSecureTextField(\n            \"è¯·è¾“å…¥refresh_token\",\n            refresh_token ? refresh_token : \"\"\n          );\n          my_alert.addCancelAction(\"å–æ¶ˆ\");\n          my_alert.addAction(\"ä¿å­˜\");\n          if ((await my_alert.present()) == 0) {\n            refresh_token = my_alert.textFieldValue(0);\n            \/\/ å…¼å®¹ä¸€äº›ç¥å¥‡çš„è¾“å…¥å½¢å¼ ------- begin\n            if (\n              refresh_token.indexOf(\"{\") != -1 &&\n              refresh_token.indexOf(\"}\") != -1\n            ) {\n              try {\n                refresh_token = JSON.parse(\/\\{.*\\}\/.exec(refresh_token)[0])[\n                  \"refreshToken\"\n                ];\n              } catch (e) {\n                console.error(e);\n                console.error(e.stack);\n              }\n            }\n            if (refresh_token.indexOf(\"=\") != -1) {\n              refresh_token = refresh_token.split(\"=\")[1];\n            }\n            if (refresh_token.indexOf(\":\") != -1) {\n              refresh_token = refresh_token\n                .split(\":\")[1]\n                .replace('\"', \"\")\n                .replace(\",\", \"\")\n                .trim();\n            }\n\n            if (refresh_token.indexOf(\"-\") != -1) {\n              refresh_token = refresh_token.split(\"-\")[0].trim();\n            }\n            if (refresh_token != my_alert.textFieldValue(0)) {\n              console.warn(\n                \"è¾“å…¥Tokençš„æ ¼å¼ä¸å¯¹ï¼Œç¨‹åºä¼šå°è¯•ä»ä¸­æå–Tokenï¼Œå¦‚æœä»ç„¶æ‰§è¡Œå¤±è´¥è¯·ä»”ç»†åœ°é˜…è¯»æ–‡æ¡£ã€‚\"\n              );\n            }\n            \/\/ å…¼å®¹ä¸€äº›ç¥å¥‡çš„è¾“å…¥å½¢å¼ -------- end\n            saveSetting(\"refresh_token\", refresh_token);\n            await previewWidget();\n          } else console.log(\"å–æ¶ˆ\");\n        },\n      },\n      {\n        title: \"ğŸ’ˆé€‰æ‹©ä¸»é¢˜\",\n        action: async () => {\n          const selection = await selectTheme();\n          if (selection >= 0) {\n            await previewWidget();\n          }\n        },\n      },\n      {\n        title: \"ğŸŒˆé€‰æ‹©è½¦è¾†é¢œè‰²\",\n        action: async () => {\n          await selectCarColor();\n          await previewWidget();\n        },\n      },\n      {\n        title: \"ğŸ–¼ï¸è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡\",\n        action: async () => {\n          const image = await Photos.fromLibrary();\n          if (!image) return;\n          const fm = getFileManager();\n          const img_dir = getImageDir();\n          const img_file_path = fm.joinPath(img_dir, \"widget_background.jpg\");\n          fm.writeImage(img_file_path, image);\n          saveSetting(\"widget_background_path\", img_file_path);\n          await previewWidget();\n        },\n      },\n      {\n        title: \"ğŸ’¬è‡ªå®šä¹‰è½¦è¾†å‹å·\",\n        action: async () => {\n          let my_alert = new Alert();\n          let car_series_name = getSetting(\"car_series_name\");\n          my_alert.title = \"è¯·è¾“å…¥è½¦è¾†å‹å·\";\n          my_alert.addTextField(\n            \"è¯·è¾“å…¥è½¦è¾†å‹å·\",\n            car_series_name ? car_series_name : \"\"\n          );\n          my_alert.addCancelAction(\"å–æ¶ˆ\");\n          my_alert.addAction(\"ä¿å­˜\");\n          if ((await my_alert.present()) == 0) {\n            car_series_name = my_alert.textFieldValue(0);\n            saveSetting(\"car_series_name\", car_series_name);\n            await previewWidget();\n          } else console.log(\"å–æ¶ˆ\");\n        },\n      },\n      {\n        title: \"ğŸš™è‡ªå®šä¹‰è½¦è¾†å›¾ç‰‡\",\n        action: async () => {\n          const image = await Photos.fromLibrary();\n          if (!image) return;\n          const fm = getFileManager();\n          const img_dir = getImageDir();\n          const img_file_path = fm.joinPath(img_dir, \"car_img.jpg\");\n          fm.writeImage(img_file_path, image);\n          saveSetting(\"car_img_path\", img_file_path);\n          await previewWidget();\n        },\n      },\n      {\n        title: \"ğŸ‰è‡ªå®šä¹‰LOGOå›¾ç‰‡\",\n        action: async () => {\n          const image = await Photos.fromLibrary();\n          if (!image) return;\n          const fm = getFileManager();\n          const img_dir = getImageDir();\n          const img_file_path = fm.joinPath(img_dir, \"logo.jpg\");\n          fm.writeImage(img_file_path, image);\n          saveSetting(\"logo_img_path\", img_file_path);\n          await previewWidget();\n        },\n      },\n      {\n        title: \"âŒ—è‡ªå®šä¹‰æ•°æ®å—\",\n        action: async () => {\n          await listDataBlocks();\n          await previewWidget();\n        },\n      },\n\n      {\n        title: \"â™»ï¸é‡ç½®è®¾å®š(ä¿ç•™token)\",\n        action: async () => {\n          initSettings();\n          await previewWidget();\n        },\n      },\n      {\n        title: \"ğŸ‘€é¢„è§ˆ\",\n        action: async () => {\n          await previewWidget();\n        },\n      },\n    ];\n    setting_actions.map((action) => {\n      alert.addAction(action.title);\n    });\n    alert.addCancelAction(\"å–æ¶ˆ\");\n    await alert.presentAlert().then((action_index) => {\n      if (action_index >= 0) {\n        return setting_actions[action_index].action();\n      }\n    });\n  }\n\n  function resetSettings() {\n    saveSetting(\"logo_img_path\", \"\");\n    saveSetting(\"car_img_path\", \"\");\n    saveSetting(\"car_series_name\", \"\");\n    saveSetting(\"widget_background_path\", \"\");\n    saveSetting(\"theme_name\", \"è·Ÿéšç³»ç»Ÿ(æ¸å˜)\");\n    saveSetting(\"widget_data_block_info\", null);\n  }\n} catch (e) {\n  console.error(e);\n  console.error(e.stack);\n}\n",
  "share_sheet_inputs" : [

  ]
}